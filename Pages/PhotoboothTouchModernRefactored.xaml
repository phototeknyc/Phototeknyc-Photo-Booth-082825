<Page x:Class="Photobooth.Pages.PhotoboothTouchModernRefactored"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:Photobooth.Pages"
      xmlns:controls="clr-namespace:Photobooth.Controls"
      mc:Ignorable="d" 
      Background="#1E1E1E"
      Title="Photobooth Touch Interface">

    <Page.Resources>
        <!-- Converters -->
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        
        <!-- BoolToBrushConverter for filter selection border -->
        <local:BoolToBrushConverter x:Key="BoolToBrushConverter" 
                                    TrueBrush="#4CAF50" 
                                    FalseBrush="Transparent"/>
        
        <!-- Modern Touch Button Style -->
        <Style x:Key="TouchButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="#FF4CAF50"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="24"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Margin" Value="10"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" 
                                CornerRadius="15"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                RenderTransformOrigin="0.5,0.5">
                            <Border.RenderTransform>
                                <ScaleTransform ScaleX="1" ScaleY="1"/>
                            </Border.RenderTransform>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#FF45A049"/>
                                <Setter TargetName="border" Property="RenderTransform">
                                    <Setter.Value>
                                        <ScaleTransform ScaleX="0.95" ScaleY="0.95"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#FF66BB6A"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Background" Value="#FF757575"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Home Button Style -->
        <Style x:Key="HomeButtonStyle" TargetType="Button" BasedOn="{StaticResource TouchButtonStyle}">
            <Setter Property="Background" Value="#FF4CAF50"/>
        </Style>
        
        <!-- Stop Button Style -->
        <Style x:Key="StopButtonStyle" TargetType="Button" BasedOn="{StaticResource TouchButtonStyle}">
            <Setter Property="Background" Value="#FFF44336"/>
        </Style>

        <!-- Settings Button Style -->
        <Style x:Key="SettingsButtonStyle" TargetType="Button" BasedOn="{StaticResource TouchButtonStyle}">
            <Setter Property="Background" Value="#FF2196F3"/>
        </Style>

        <!-- Sharing Button Style -->
        <Style x:Key="SharingButtonStyle" TargetType="Button" BasedOn="{StaticResource TouchButtonStyle}">
            <Setter Property="Background" Value="#FF4CAF50"/>
        </Style>
    </Page.Resources>

    <Grid x:Name="MainGrid" ClipToBounds="False">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Session Selection Modal (Overlay) -->
        <controls:SessionSelectionModal x:Name="SessionSelectionModal" 
                                        Grid.RowSpan="3"
                                        Panel.ZIndex="1000"/>
        
        <!-- Gallery Browser Modal (Overlay) -->
        <controls:GalleryBrowserModal x:Name="GalleryBrowserModal"
                                      Grid.RowSpan="3"
                                      Panel.ZIndex="999"/>
        
        <!-- Capture Modes Overlay -->
        <controls:CaptureModesOverlay x:Name="CaptureModesOverlay"
                                      Grid.RowSpan="3"
                                      Panel.ZIndex="998"/>
        
        <!-- Session Timeout Progress Bar -->
        <Border x:Name="SessionTimeoutProgressBar"
                Grid.Row="0"
                VerticalAlignment="Top"
                HorizontalAlignment="Stretch"
                Height="4"
                Background="Transparent"
                Panel.ZIndex="996"
                Visibility="Collapsed">
            <Grid>
                <!-- Background track -->
                <Rectangle Fill="#33FFFFFF" />
                <!-- Progress fill -->
                <Rectangle x:Name="SessionTimeoutProgressFill"
                          Fill="#4CAF50"
                          HorizontalAlignment="Left"
                          Width="0">
                    <Rectangle.OpacityMask>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                            <GradientStop Color="#FF4CAF50" Offset="0.0"/>
                            <GradientStop Color="#FF66BB6A" Offset="0.5"/>
                            <GradientStop Color="#FF4CAF50" Offset="1.0"/>
                        </LinearGradientBrush>
                    </Rectangle.OpacityMask>
                </Rectangle>
            </Grid>
        </Border>

        <!-- Video Recording Indicator -->
        <Grid x:Name="VideoRecordingGrid"
              Grid.RowSpan="3"
              Panel.ZIndex="997"
              Visibility="Collapsed">
            <!-- Recording Indicator -->
            <Border HorizontalAlignment="Center"
                    VerticalAlignment="Top"
                    Margin="0,20,0,0"
                    Background="#CC000000"
                    CornerRadius="5"
                    Padding="20,10">
                <StackPanel Orientation="Horizontal">
                    <Ellipse Width="15" Height="15" Fill="Red" Margin="0,0,10,0">
                        <Ellipse.Triggers>
                            <EventTrigger RoutedEvent="Loaded">
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                       From="1" To="0.3" Duration="0:0:0.5"
                                                       AutoReverse="True" RepeatBehavior="Forever"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </EventTrigger>
                        </Ellipse.Triggers>
                    </Ellipse>
                    <TextBlock Text="RECORDING" 
                             Foreground="White" 
                             FontSize="18" 
                             FontWeight="Bold"
                             Margin="0,0,15,0"/>
                    <TextBlock x:Name="RecordingDurationText" 
                             Text="00:00" 
                             Foreground="White" 
                             FontSize="18"/>
                </StackPanel>
            </Border>
            
            <!-- Stop Recording Button -->
            <Button x:Name="StopVideoButton"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Bottom"
                    Margin="0,0,0,100"
                    Width="200"
                    Height="60"
                    Click="StopVideoButton_Click"
                    Style="{StaticResource TouchButtonStyle}">
                <StackPanel Orientation="Horizontal">
                    <Rectangle Width="20" Height="20" Fill="Red" Margin="0,0,10,0"/>
                    <TextBlock Text="STOP RECORDING" FontSize="16" FontWeight="Bold"/>
                </StackPanel>
            </Button>
        </Grid>
        
        <!-- Main Live View Area -->
        <Grid Grid.Row="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <!-- Gallery Preview Box (Left Side) - Hidden since we have browse button in overlay -->
            <Border x:Name="galleryPreviewBox"
                    Grid.Column="0"
                    Width="200"
                    Height="250"
                    Margin="20,20,10,20"
                    Background="#3E3E3E"
                    CornerRadius="10"
                    Cursor="Hand"
                    MouseLeftButtonDown="GalleryPreviewBox_Click"
                    MouseEnter="GalleryPreviewBox_MouseEnter"
                    MouseLeave="GalleryPreviewBox_MouseLeave"
                    Visibility="Collapsed">
                <Border.Effect>
                    <DropShadowEffect Color="Black" BlurRadius="10" ShadowDepth="3" Opacity="0.3"/>
                </Border.Effect>
                <Grid>
                    <!-- Preview Image -->
                    <Image x:Name="galleryPreviewImage"
                           Stretch="UniformToFill"
                           Margin="5"/>
                    
                    <!-- Overlay with gallery info -->
                    <Border VerticalAlignment="Bottom"
                            Background="#CC000000"
                            CornerRadius="0,0,10,10">
                        <StackPanel Margin="10,5">
                            <TextBlock Text="📸 Gallery"
                                       Foreground="White"
                                       FontSize="16"
                                       FontWeight="Bold"/>
                            <TextBlock x:Name="galleryPreviewInfo"
                                       Text="No sessions"
                                       Foreground="#CCCCCC"
                                       FontSize="12"/>
                        </StackPanel>
                    </Border>
                    
                    <!-- Hover effect -->
                    <Border x:Name="galleryPreviewHover"
                            Background="#33FFFFFF"
                            CornerRadius="10"
                            Visibility="Collapsed">
                        <TextBlock Text="Click to browse"
                                   Foreground="White"
                                   FontSize="14"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"/>
                    </Border>
                </Grid>
            </Border>
            
            <!-- Main View Area (Full Width - Gallery Preview Hidden) -->
            <Border Grid.Column="0" Grid.ColumnSpan="2" Background="#2E2E2E" CornerRadius="10" Margin="20,20,20,20" ClipToBounds="True">
                <Grid ClipToBounds="True">
                    <Image x:Name="liveViewImage"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           Stretch="Uniform"
                           RenderTransformOrigin="0.5,0.5">
                        <Image.RenderTransform>
                            <RotateTransform x:Name="liveViewRotateTransform" Angle="0"/>
                        </Image.RenderTransform>
                    </Image>

                    <!-- Idle Background Image (shows when live view is not active) -->
                    <Image x:Name="idleBackgroundImage"
                           Stretch="UniformToFill"
                           HorizontalAlignment="Stretch"
                           VerticalAlignment="Stretch"
                           Opacity="1.0"
                           Visibility="Collapsed"/>

                    <!-- Template Overlay for Live View -->
                    <Grid x:Name="templateOverlayContainer"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch"
                          IsHitTestVisible="False"
                          Visibility="Collapsed">
                        <!-- Semi-transparent mask for areas outside placeholders -->
                        <Rectangle x:Name="templateOverlayMask"
                                   Fill="Black"
                                   Opacity="0.2"
                                   Visibility="Collapsed"/>

                        <!-- Canvas for template placeholder outlines -->
                        <Canvas x:Name="templateOverlayCanvas"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                ClipToBounds="True">
                            <!-- Placeholder outlines will be added dynamically -->
                        </Canvas>

                        <!-- Template guide text -->
                        <Border Background="#CC000000"
                                CornerRadius="4"
                                Padding="8,4"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Top"
                                Margin="10">
                            <TextBlock Text="Template Guide"
                                       Foreground="#4CAF50"
                                       FontSize="12"/>
                        </Border>
                    </Grid>

                    <!-- FPS Debug Display (Hidden by default) -->
                    <Border x:Name="debugFpsBorder"
                            Background="#CC000000"
                            CornerRadius="4"
                            Padding="8,4"
                            HorizontalAlignment="Left"
                            VerticalAlignment="Top"
                            Margin="10"
                            Visibility="Collapsed">
                        <TextBlock x:Name="debugFpsText"
                                   Text="FPS: 0.0"
                                   Foreground="#FFFF00"
                                   FontSize="14"
                                   FontWeight="Bold"/>
                    </Border>

                    <!-- Centered Start Button -->
                    <Border x:Name="startButtonOverlay"
                            Width="300"
                            Height="300"
                            CornerRadius="150"
                            Background="#CC4CAF50"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Cursor="Hand"
                            MouseLeftButtonDown="StartButton_Click"
                            Visibility="Collapsed">
                        <Border.Effect>
                            <DropShadowEffect Color="Black" BlurRadius="20" ShadowDepth="5" Opacity="0.5"/>
                        </Border.Effect>
                        <Grid>
                            <TextBlock x:Name="startButtonTextLine1"
                                       Text="TOUCH TO"
                                       FontSize="32"
                                       FontWeight="Bold"
                                       Foreground="White"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       Margin="0,-50,0,0"/>
                            <TextBlock x:Name="startButtonTextLine2"
                                       Text="START"
                                       FontSize="48"
                                       FontWeight="Bold"
                                       Foreground="White"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       Margin="0,40,0,0"/>
                        </Grid>
                    </Border>
                    
                    <!-- Countdown Overlay -->
                    <Grid x:Name="countdownOverlay" 
                          Background="#80000000" 
                          Visibility="Collapsed">
                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                            <TextBlock x:Name="countdownText" 
                                       Text="3" 
                                       FontSize="200" 
                                       FontWeight="Bold" 
                                       Foreground="White" 
                                       HorizontalAlignment="Center"/>
                            <TextBlock Text="Get Ready!" 
                                       FontSize="36" 
                                       Foreground="White" 
                                       HorizontalAlignment="Center" 
                                       Margin="0,20,0,0"/>
                        </StackPanel>
                    </Grid>
                    
                    <!-- Stop Button (Top Right) -->
                    <Button x:Name="stopSessionButton"
                            Width="50"
                            Height="50"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Top"
                            Margin="0,20,20,0"
                            Background="#CCFF5252"
                            BorderThickness="0"
                            Visibility="Collapsed"
                            Click="StopButton_Click"
                            Cursor="Hand"
                            ToolTip="Stop Session"
                            Panel.ZIndex="1000">
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border Background="{TemplateBinding Background}" 
                                        CornerRadius="25">
                                    <TextBlock Text="✕"
                                               FontSize="24"
                                               FontWeight="Bold"
                                               Foreground="White"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"/>
                                </Border>
                            </ControlTemplate>
                        </Button.Template>
                    </Button>
                    
                    <!-- Video Recording Indicator -->
                    <Border x:Name="videoRecordingIndicator"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Top"
                            Margin="0,20,0,0"
                            Background="#CCFF0000"
                            CornerRadius="10"
                            Padding="15,8"
                            Visibility="Collapsed"
                            Panel.ZIndex="1001">
                        <StackPanel Orientation="Horizontal">
                            <!-- Recording dot animation -->
                            <Ellipse Width="12" Height="12" Fill="White" Margin="0,0,10,0">
                                <Ellipse.Triggers>
                                    <EventTrigger RoutedEvent="Ellipse.Loaded">
                                        <BeginStoryboard>
                                            <Storyboard RepeatBehavior="Forever">
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                From="1.0" To="0.3" Duration="0:0:1"
                                                                AutoReverse="True"/>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </EventTrigger>
                                </Ellipse.Triggers>
                            </Ellipse>
                            <TextBlock Text="RECORDING" 
                                       Foreground="White" 
                                       FontWeight="Bold" 
                                       FontSize="14"
                                       VerticalAlignment="Center"/>
                            <TextBlock x:Name="recordingDurationText" 
                                       Text=" 00:00" 
                                       Foreground="White" 
                                       FontWeight="Normal" 
                                       FontSize="14"
                                       VerticalAlignment="Center"
                                       Margin="10,0,0,0"/>
                        </StackPanel>
                    </Border>
                    
                    <!-- Cancel Session Button (only visible during active session) -->
                    <Button x:Name="cancelSessionButton"
                            Width="120"
                            Height="45"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Bottom"
                            Margin="0,0,20,20"
                            Background="#EEFF5252"
                            BorderThickness="0"
                            Visibility="Collapsed"
                            Click="CancelSessionButton_Click"
                            Cursor="Hand"
                            ToolTip="Cancel Current Session"
                            Panel.ZIndex="999">
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border Background="{TemplateBinding Background}" 
                                        CornerRadius="22">
                                    <Border.Effect>
                                        <DropShadowEffect Color="Black" BlurRadius="8" ShadowDepth="3" Opacity="0.4"/>
                                    </Border.Effect>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                        <TextBlock Text="✕"
                                                   FontSize="16"
                                                   FontWeight="Bold"
                                                   Foreground="White"
                                                   Margin="0,0,5,0"
                                                   VerticalAlignment="Center"/>
                                        <TextBlock Text="Cancel"
                                                   FontSize="14"
                                                   FontWeight="SemiBold"
                                                   Foreground="White"
                                                   VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Border>
                            </ControlTemplate>
                        </Button.Template>
                    </Button>
                    
                    <!-- Status Messages -->
                    <Border VerticalAlignment="Top" 
                            HorizontalAlignment="Center" 
                            Background="#CC000000" 
                            CornerRadius="20" 
                            Padding="20,10" 
                            Margin="0,20,0,0">
                        <TextBlock x:Name="statusText" 
                                   Text="Touch START to begin" 
                                   FontSize="24" 
                                   Foreground="White" 
                                   HorizontalAlignment="Center"/>
                    </Border>
                    
                    <!-- Lock Button (Top Left - Non-obtrusive) -->
                    <Button x:Name="lockButton"
                            Width="45"
                            Height="45"
                            HorizontalAlignment="Left"
                            VerticalAlignment="Top"
                            Margin="20,20,0,0"
                            Background="#33FFFFFF"
                            BorderThickness="0"
                            Click="LockButton_Click"
                            Cursor="Hand"
                            ToolTip="Lock/Unlock Settings"
                            Panel.ZIndex="100">
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border Background="{TemplateBinding Background}" 
                                        CornerRadius="22.5">
                                    <Border.Effect>
                                        <DropShadowEffect Color="Black" BlurRadius="5" ShadowDepth="2" Opacity="0.3"/>
                                    </Border.Effect>
                                    <TextBlock x:Name="lockIcon"
                                               Text="🔓"
                                               FontSize="20"
                                               Foreground="White"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"/>
                                </Border>
                            </ControlTemplate>
                        </Button.Template>
                    </Button>
                    
                    <!-- Gallery Preview Box (Under Lock Button in Overlay) -->
                    <Border x:Name="galleryPreviewBoxOverlay"
                            Width="150"
                            Height="180"
                            HorizontalAlignment="Left"
                            VerticalAlignment="Top"
                            Margin="20,80,0,0"
                            Background="#CC3E3E3E"
                            CornerRadius="10"
                            Cursor="Hand"
                            MouseLeftButtonDown="GalleryPreviewBox_Click"
                            MouseEnter="GalleryPreviewBox_MouseEnter"
                            MouseLeave="GalleryPreviewBox_MouseLeave"
                            Panel.ZIndex="99">
                        <Border.Effect>
                            <DropShadowEffect Color="Black" BlurRadius="8" ShadowDepth="3" Opacity="0.4"/>
                        </Border.Effect>
                        <Grid>
                            <!-- Preview Image -->
                            <Image x:Name="galleryPreviewImageOverlay"
                                   Stretch="UniformToFill"
                                   Margin="3"/>
                            
                            <!-- Overlay with gallery info -->
                            <Border VerticalAlignment="Bottom"
                                    Background="#DD000000"
                                    CornerRadius="0,0,10,10">
                                <StackPanel Margin="8,4">
                                    <TextBlock Text="📸 Gallery"
                                               Foreground="White"
                                               FontSize="14"
                                               FontWeight="Bold"/>
                                    <TextBlock x:Name="galleryPreviewInfoOverlay"
                                               Text="No sessions"
                                               Foreground="#CCCCCC"
                                               FontSize="11"/>
                                </StackPanel>
                            </Border>
                            
                            <!-- Hover effect -->
                            <Border x:Name="galleryPreviewHoverOverlay"
                                    Background="#44FFFFFF"
                                    CornerRadius="10"
                                    Visibility="Collapsed">
                                <TextBlock Text="Click to browse"
                                           Foreground="White"
                                           FontSize="13"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"/>
                            </Border>
                        </Grid>
                    </Border>
                    
                    <!-- Video Playback Controls -->
                    <Grid x:Name="VideoPlaybackControls"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Bottom"
                          Margin="0,0,0,30"
                          Visibility="Collapsed"
                          Panel.ZIndex="1000">
                        <Border Background="#AA000000" 
                                CornerRadius="25"
                                Padding="20,10">
                            <StackPanel Orientation="Horizontal">
                                <!-- Play/Pause Button -->
                                <Button x:Name="PlayPauseButton"
                                        Width="60"
                                        Height="60"
                                        Click="PlayPauseButton_Click"
                                        Cursor="Hand"
                                        ToolTip="Play/Pause"
                                        Margin="0,0,10,0">
                                    <Button.Template>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="PlayPauseBorder" Background="#FF4CAF50" 
                                                    CornerRadius="30">
                                                <Border.Effect>
                                                    <DropShadowEffect Color="Black" BlurRadius="10" ShadowDepth="2" Opacity="0.3"/>
                                                </Border.Effect>
                                                <TextBlock x:Name="PlayPauseIcon"
                                                           Text="⏸"
                                                           FontSize="28"
                                                           FontWeight="Bold"
                                                           Foreground="White"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="PlayPauseBorder" Property="Background" Value="#FF5CBF5C"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Button.Template>
                                </Button>
                                
                                <!-- Stop Button -->
                                <Button x:Name="VideoStopButton"
                                        Width="60"
                                        Height="60"
                                        Click="VideoStopButton_Click"
                                        Cursor="Hand"
                                        ToolTip="Stop"
                                        Margin="0,0,10,0">
                                    <Button.Template>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="StopBorder" Background="#FFFF5252" 
                                                    CornerRadius="30">
                                                <Border.Effect>
                                                    <DropShadowEffect Color="Black" BlurRadius="10" ShadowDepth="2" Opacity="0.3"/>
                                                </Border.Effect>
                                                <TextBlock Text="⏹"
                                                           FontSize="28"
                                                           FontWeight="Bold"
                                                           Foreground="White"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="StopBorder" Property="Background" Value="#FFFF6B6B"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Button.Template>
                                </Button>
                                
                                <!-- Replay Button -->
                                <Button x:Name="VideoReplayButton"
                                        Width="60"
                                        Height="60"
                                        Click="VideoReplayButton_Click"
                                        Cursor="Hand"
                                        ToolTip="Replay">
                                    <Button.Template>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="ReplayBorder" Background="#FF2196F3" 
                                                    CornerRadius="30">
                                                <Border.Effect>
                                                    <DropShadowEffect Color="Black" BlurRadius="10" ShadowDepth="2" Opacity="0.3"/>
                                                </Border.Effect>
                                                <TextBlock Text="↻"
                                                           FontSize="32"
                                                           FontWeight="Bold"
                                                           Foreground="White"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="ReplayBorder" Property="Background" Value="#FF42A5F5"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Button.Template>
                                </Button>
                            </StackPanel>
                        </Border>
                    </Grid>
                    
                    <!-- Info Panel - Bottom Left -->
                    <Border VerticalAlignment="Bottom" 
                            HorizontalAlignment="Left" 
                            Background="#CC333333" 
                            CornerRadius="10" 
                            Padding="15" 
                            Margin="20,0,0,100"
                            MinWidth="250">
                        <StackPanel>
                            <!-- Camera Status -->
                            <TextBlock x:Name="cameraStatusText" 
                                       Text="Connecting..." 
                                       FontSize="14" 
                                       Foreground="White" 
                                       HorizontalAlignment="Center" 
                                       TextWrapping="Wrap"/>
                            
                            <!-- Photo Count -->
                            <TextBlock x:Name="photoCountText" 
                                       Text="" 
                                       FontSize="16" 
                                       FontWeight="Bold" 
                                       Foreground="#4CAF50" 
                                       HorizontalAlignment="Center"
                                       Margin="0,5,0,0"
                                       Visibility="Collapsed"/>
                            
                            <!-- Cloud Sync Status -->
                            <Border Background="Transparent" 
                                    CornerRadius="8" 
                                    Margin="0,8,0,0"
                                    Padding="8,5">
                                <StackPanel>
                                    <TextBlock Text="SYNC STATUS" 
                                               FontSize="10" 
                                               FontWeight="Bold"
                                               Foreground="#00B4D8" 
                                               HorizontalAlignment="Center"
                                               Margin="0,0,0,3"/>
                                    
                                    <!-- Sync Status Display -->
                                    <Grid HorizontalAlignment="Center">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <!-- Status Icon -->
                                        <Border x:Name="syncStatusIcon" 
                                                Grid.Column="0"
                                                Width="8" 
                                                Height="8" 
                                                CornerRadius="4"
                                                Background="#4CAF50"
                                                Margin="0,0,5,0"
                                                VerticalAlignment="Center">
                                            <Border.ToolTip>
                                                <ToolTip x:Name="syncStatusTooltip" Content="All uploads current"/>
                                            </Border.ToolTip>
                                        </Border>
                                        
                                        <!-- Status Text -->
                                        <TextBlock x:Name="syncStatusText" 
                                                   Grid.Column="1"
                                                   Text="Uploads Current" 
                                                   FontSize="12" 
                                                   Foreground="#4CAF50"
                                                   VerticalAlignment="Center"/>
                                    </Grid>
                                    
                                    <!-- Pending Count (hidden by default) -->
                                    <TextBlock x:Name="syncPendingCount" 
                                               Text="0 items pending" 
                                               FontSize="10" 
                                               Foreground="#FFA726"
                                               HorizontalAlignment="Center"
                                               Margin="0,2,0,0"
                                               Visibility="Collapsed"/>
                                    
                                    <!-- Upload Progress (hidden by default) -->
                                    <ProgressBar x:Name="syncUploadProgress" 
                                                 Height="3"
                                                 Margin="0,3,0,0"
                                                 Foreground="#00B4D8"
                                                 Background="#333"
                                                 Visibility="Collapsed"/>
                                </StackPanel>
                            </Border>
                            
                            <!-- Separator -->
                            <Border Height="1" 
                                    Background="#666" 
                                    Margin="0,10,0,10"/>
                            
                            <!-- Printer Status Header -->
                            <TextBlock Text="PRINTER STATUS" 
                                       FontSize="11" 
                                       FontWeight="Bold"
                                       Foreground="#00B4D8" 
                                       HorizontalAlignment="Center"
                                       Margin="0,0,0,5"/>
                            
                            <!-- Printer Info -->
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <!-- Printer Name and Connection -->
                                <StackPanel Grid.Row="0" Orientation="Horizontal" HorizontalAlignment="Center">
                                    <TextBlock x:Name="printerNameText" 
                                               Text="No Printer" 
                                               FontSize="12" 
                                               Foreground="White"
                                               FontWeight="SemiBold"/>
                                    <TextBlock x:Name="printerConnectionText" 
                                               Text=" (Offline)" 
                                               FontSize="12" 
                                               Foreground="#FF9800"
                                               FontWeight="Normal"/>
                                </StackPanel>
                                
                                <!-- Printer Status -->
                                <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,3,0,0">
                                    <Border x:Name="printerStatusIndicator" 
                                            Width="8" 
                                            Height="8" 
                                            CornerRadius="4"
                                            Background="#4CAF50"
                                            Margin="0,0,5,0"
                                            VerticalAlignment="Center"/>
                                    <TextBlock x:Name="printerStatusText" 
                                               Text="Ready" 
                                               FontSize="13" 
                                               Foreground="#4CAF50"
                                               FontWeight="Normal"/>
                                </StackPanel>
                                
                                <!-- Print Queue and Media Info -->
                                <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,3,0,0">
                                    <TextBlock Text="Queue: " 
                                               FontSize="11" 
                                               Foreground="#AAA"/>
                                    <TextBlock x:Name="printerQueueText" 
                                               Text="0" 
                                               FontSize="11" 
                                               Foreground="White"
                                               FontWeight="Bold"/>
                                    <TextBlock Text=" Jobs" 
                                               FontSize="11" 
                                               Foreground="#AAA"
                                               Margin="2,0,0,0"/>
                                    
                                    <!-- Media Remaining (inline with queue) -->
                                    <StackPanel x:Name="mediaRemainingPanel" 
                                                Orientation="Horizontal" 
                                                Margin="10,0,0,0"
                                                Visibility="Collapsed">
                                        <TextBlock Text="•" 
                                                   FontSize="11" 
                                                   Foreground="#666"
                                                   Margin="0,0,5,0"/>
                                        <TextBlock x:Name="mediaRemainingText" 
                                                   Text="400" 
                                                   FontSize="11" 
                                                   Foreground="#4CAF50"
                                                   FontWeight="Bold"/>
                                        <TextBlock x:Name="mediaTypeText" 
                                                   Text=" prints left" 
                                                   FontSize="11" 
                                                   Foreground="#AAA"
                                                   Margin="2,0,0,0"/>
                                    </StackPanel>
                                </StackPanel>
                                
                                <!-- Empty Row 3 (was used for media) -->
                            </Grid>
                            
                            <!-- Error Message (if any) -->
                            <TextBlock x:Name="printerErrorText" 
                                       Text="" 
                                       FontSize="11" 
                                       Foreground="#FF5252"
                                       HorizontalAlignment="Center"
                                       TextWrapping="Wrap"
                                       Margin="0,5,0,0"
                                       Visibility="Collapsed"/>
                            
                            <!-- Separator for Cloud Share Status -->
                            <Border Height="1" 
                                    Background="#666" 
                                    Margin="0,10,0,10"/>
                            
                            <!-- Cloud Share Status Header -->
                            <TextBlock Text="CLOUD SHARE" 
                                       FontSize="11" 
                                       FontWeight="Bold"
                                       Foreground="#00B4D8" 
                                       HorizontalAlignment="Center"
                                       Margin="0,0,0,5"/>
                            
                            <!-- Cloud Share Status -->
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <TextBlock FontFamily="{StaticResource SegoeMDL2}"
                                           Text="{StaticResource MDL2_Cloud}"
                                           FontSize="14"
                                           x:Name="cloudSyncIcon"
                                           Foreground="#888"
                                           VerticalAlignment="Center"
                                           Margin="0,0,8,0"/>
                                <StackPanel>
                                    <TextBlock x:Name="cloudSyncStatusText" 
                                               Text="Not Configured" 
                                               FontSize="12" 
                                               Foreground="#FF9800"
                                               FontWeight="SemiBold"/>
                                    <TextBlock x:Name="cloudSyncBucketText" 
                                               Text="Setup in settings" 
                                               FontSize="10" 
                                               Foreground="#888"
                                               Visibility="Visible"/>
                                </StackPanel>
                            </StackPanel>
                            
                            <!-- Upload Status (shown during uploads) -->
                            <StackPanel x:Name="cloudUploadStatusPanel" 
                                        Visibility="Collapsed"
                                        Margin="0,5,0,0">
                                <ProgressBar x:Name="cloudUploadProgress" 
                                             Height="3"
                                             Margin="0,2"
                                             Foreground="#4CAF50"
                                             Background="#333"/>
                                <TextBlock x:Name="cloudUploadStatusText" 
                                           Text="Uploading..." 
                                           FontSize="10" 
                                           Foreground="#4CAF50"
                                           HorizontalAlignment="Center"/>
                            </StackPanel>
                            
                            <!-- Separator for Cloud Sync Status -->
                            <Border Height="1" 
                                    Background="#666" 
                                    Margin="0,10,0,10"/>
                            
                            <!-- Cloud Sync Status Header -->
                            <TextBlock Text="CLOUD SYNC" 
                                       FontSize="11" 
                                       FontWeight="Bold"
                                       Foreground="#00B4D8" 
                                       HorizontalAlignment="Center"
                                       Margin="0,0,0,5"/>
                            
                            <!-- Cloud Sync Status (Settings/Templates/Events) -->
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <TextBlock FontFamily="{StaticResource SegoeMDL2}"
                                           Text="{StaticResource MDL2_Sync}"
                                           FontSize="14"
                                           x:Name="cloudRealSyncIcon"
                                           Foreground="#888"
                                           VerticalAlignment="Center"
                                           Margin="0,0,8,0"/>
                                <StackPanel>
                                    <TextBlock x:Name="cloudRealSyncStatusText" 
                                               Text="Sync Disabled" 
                                               FontSize="12" 
                                               Foreground="#888"
                                               FontWeight="SemiBold"/>
                                    <TextBlock x:Name="cloudRealSyncInfoText" 
                                               Text="Enable in settings" 
                                               FontSize="10" 
                                               Foreground="#888"
                                               Visibility="Visible"/>
                                </StackPanel>
                            </StackPanel>
                            
                            <!-- Sync Progress (shown during sync) -->
                            <StackPanel x:Name="cloudRealSyncProgressPanel" 
                                        Visibility="Collapsed"
                                        Margin="0,5,0,0">
                                <ProgressBar x:Name="cloudRealSyncProgress" 
                                             Height="3"
                                             Margin="0,2"
                                             Foreground="#2196F3"
                                             Background="#333"/>
                                <TextBlock x:Name="cloudRealSyncProgressText" 
                                           Text="Syncing..." 
                                           FontSize="10" 
                                           Foreground="#2196F3"
                                           HorizontalAlignment="Center"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                    
                    <!-- Countdown Quick Controls (Floating Panel) -->
                    <Border VerticalAlignment="Top" 
                            HorizontalAlignment="Right" 
                            Background="#CC333333" 
                            CornerRadius="10" 
                            Padding="10" 
                            Margin="0,80,20,0">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Countdown:" 
                                       FontSize="14" 
                                       Foreground="White" 
                                       VerticalAlignment="Center" 
                                       Margin="0,0,10,0"/>
                            <Button Content="-" 
                                    Width="40" 
                                    Height="40" 
                                    FontSize="20" 
                                    FontWeight="Bold"
                                    Background="#FF555555"
                                    Foreground="White"
                                    BorderThickness="0"
                                    Click="DecreaseCountdown_Click">
                                <Button.Template>
                                    <ControlTemplate TargetType="Button">
                                        <Border Background="{TemplateBinding Background}" 
                                                CornerRadius="20">
                                            <ContentPresenter HorizontalAlignment="Center" 
                                                              VerticalAlignment="Center"/>
                                        </Border>
                                    </ControlTemplate>
                                </Button.Template>
                            </Button>
                            <TextBlock x:Name="countdownSecondsDisplay" 
                                       Text="5s" 
                                       FontSize="20" 
                                       FontWeight="Bold" 
                                       Foreground="#4CAF50" 
                                       VerticalAlignment="Center" 
                                       Margin="10,0,10,0"/>
                            <Button Content="+" 
                                    Width="40" 
                                    Height="40" 
                                    FontSize="20" 
                                    FontWeight="Bold"
                                    Background="#FF555555"
                                    Foreground="White"
                                    BorderThickness="0"
                                    Click="IncreaseCountdown_Click">
                                <Button.Template>
                                    <ControlTemplate TargetType="Button">
                                        <Border Background="{TemplateBinding Background}" 
                                                CornerRadius="20">
                                            <ContentPresenter HorizontalAlignment="Center" 
                                                              VerticalAlignment="Center"/>
                                        </Border>
                                    </ControlTemplate>
                                </Button.Template>
                            </Button>
                        </StackPanel>
                    </Border>
                    
                    <!-- Back Button removed from here - moved to bottom control bar -->
                </Grid>
            </Border>
        </Grid>
        
        <!-- Bottom Control Area (Row 1) -->
        <Grid Grid.Row="1" Margin="20,0,20,10">
            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                <StackPanel x:Name="photosContainer" 
                            Orientation="Horizontal" 
                            HorizontalAlignment="Center">
                    <!-- Captured photos will be added here dynamically -->
                </StackPanel>
            </ScrollViewer>
        </Grid>
        
        <!-- Action Buttons Area (Row 2) -->
        <Grid Grid.Row="2" Margin="20,10,20,20" ClipToBounds="False">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" ClipToBounds="False">
                
                <!-- Unified Action Buttons Panel (works for both session completion and gallery) -->
                <StackPanel x:Name="actionButtonsPanel" 
                           Orientation="Horizontal" 
                           HorizontalAlignment="Center" 
                           ClipToBounds="False"
                           Visibility="Collapsed">
                    
                    <!-- Share Button -->
                    <Button x:Name="shareButton"
                            Style="{StaticResource TouchButtonStyle}"
                            Background="#2196F3"
                            Width="80"
                            Height="80"
                            Margin="10"
                            ToolTip="Share Photos"
                            Click="ShareButton_Click">
                        <TextBlock Text="{StaticResource MDL2_Share}"
                                   FontFamily="{StaticResource SegoeMDL2}"
                                   FontSize="32"
                                   Foreground="White"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"/>
                    </Button>
                    
                    <!-- Print Button -->
                    <Button x:Name="printButton"
                            Style="{StaticResource TouchButtonStyle}"
                            Background="#4CAF50"
                            Width="80"
                            Height="80"
                            Margin="10"
                            ToolTip="Print Photos"
                            Click="PrintButton_Click">
                        <TextBlock Text="{StaticResource MDL2_Print}"
                                   FontFamily="{StaticResource SegoeMDL2}"
                                   FontSize="32"
                                   Foreground="White"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"/>
                    </Button>
                    
                    <!-- Email Button -->
                    <Button x:Name="emailButton"
                            Style="{StaticResource TouchButtonStyle}"
                            Background="#FF9800"
                            Width="80"
                            Height="80"
                            Margin="10"
                            ToolTip="Email Photos"
                            Click="EmailButton_Click">
                        <TextBlock Text="{StaticResource MDL2_Mail}"
                                   FontFamily="{StaticResource SegoeMDL2}"
                                   FontSize="32"
                                   Foreground="White"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"/>
                    </Button>
                    
                    <!-- SMS Button with Status Indicator -->
                    <Button x:Name="smsButton"
                            Style="{StaticResource TouchButtonStyle}"
                            Background="#9C27B0"
                            Width="80"
                            Height="80"
                            Margin="10"
                            ToolTip="Send SMS"
                            Click="SmsButton_Click">
                        <Grid>
                            <TextBlock Text="{StaticResource MDL2_Message}"
                                       FontFamily="{StaticResource SegoeMDL2}"
                                       FontSize="32"
                                       Foreground="White"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"/>
                            <!-- SMS Status Indicator (inside button) -->
                            <Border x:Name="smsStatusIndicator"
                                    Width="16" Height="16"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Top"
                                    Margin="0,2,2,0"
                                    CornerRadius="8"
                                    Background="#4CAF50"
                                    Visibility="Collapsed">
                                <Border.Effect>
                                    <DropShadowEffect ShadowDepth="1" Opacity="0.5"/>
                                </Border.Effect>
                                <Viewbox Margin="2" Stretch="Uniform">
                                    <Path x:Name="smsStatusIcon"
                                          Data="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"
                                          Fill="White"
                                          Stretch="Uniform"/>
                                </Viewbox>
                            </Border>
                        </Grid>
                    </Button>
                    
                    <!-- QR Code Button with Status Indicator -->
                    <Button x:Name="qrButton"
                            Style="{StaticResource TouchButtonStyle}"
                            Background="#607D8B"
                            Width="80"
                            Height="80"
                            Margin="10"
                            ToolTip="Show QR Code"
                            Click="QrButton_Click">
                        <Grid>
                            <TextBlock Text="{StaticResource MDL2_QRCode}"
                                       FontFamily="{StaticResource SegoeMDL2}"
                                       FontSize="32"
                                       Foreground="White"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"/>
                            <!-- QR Status Indicator (inside button) -->
                            <Border x:Name="qrStatusIndicator"
                                    Width="16" Height="16"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Top"
                                    Margin="0,2,2,0"
                                    CornerRadius="8"
                                    Background="#4CAF50"
                                    Visibility="Collapsed">
                                <Border.Effect>
                                    <DropShadowEffect ShadowDepth="1" Opacity="0.5"/>
                                </Border.Effect>
                                <Viewbox Margin="2" Stretch="Uniform">
                                    <Path x:Name="qrStatusIcon"
                                          Data="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"
                                          Fill="White"
                                          Stretch="Uniform"/>
                                </Viewbox>
                            </Border>
                        </Grid>
                    </Button>
                    
                    <!-- Done Button -->
                    <Button x:Name="doneButton"
                            Style="{StaticResource TouchButtonStyle}"
                            Background="#4CAF50"
                            Width="80"
                            Height="80"
                            Margin="10"
                            ToolTip="Done"
                            Click="DoneButton_Click">
                        <TextBlock Text="{StaticResource MDL2_CheckMark}"
                                   FontFamily="{StaticResource SegoeMDL2}"
                                   FontSize="32"
                                   Foreground="White"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"/>
                    </Button>
                    
                    <!-- Exit Button (for gallery mode) -->
                    <Button x:Name="exitButton"
                            Style="{StaticResource TouchButtonStyle}"
                            Background="#F44336"
                            Width="80"
                            Height="80"
                            Margin="10"
                            ToolTip="Exit to Menu"
                            Visibility="Collapsed"
                            Click="ExitButton_Click">
                        <TextBlock Text="{StaticResource MDL2_Cancel}"
                                   FontFamily="{StaticResource SegoeMDL2}"
                                   FontSize="32"
                                   Foreground="White"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"/>
                    </Button>
                </StackPanel>
                
                <!-- Settings Button -->
                <Button x:Name="settingsButton"
                        Content="⚙️ SETTINGS"
                        Style="{StaticResource SettingsButtonStyle}"
                        Width="180"
                        Height="70"
                        FontSize="20"
                        Visibility="Collapsed"
                        Click="SettingsButton_Click"/>
                
                
                <!-- Removed duplicate gallery navigation panel - using unified actionButtonsPanel instead -->
            </StackPanel>
        </Grid>
        
        <!-- Bottom Control Bar (Collapsible) -->
        <Border x:Name="bottomControlBar"
                Grid.Row="2"
                Background="#333333"
                Padding="20"
                Visibility="Collapsed">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <!-- All Buttons in Single Panel -->
                <StackPanel Grid.Column="0" Grid.ColumnSpan="3" Orientation="Horizontal" HorizontalAlignment="Left">
                    <!-- Back Button -->
                    <Button x:Name="backButton"
                            Style="{StaticResource TouchButtonStyle}"
                            Background="#2196F3"
                            Width="120" 
                            Height="50" 
                            Margin="5"
                            Click="BackButton_Click"
                            ToolTip="Go Back">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="←" FontSize="20" Margin="0,0,6,0" VerticalAlignment="Center"/>
                            <TextBlock Text="Back" FontSize="16" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    
                    <!-- Event Button -->
                    <Button Style="{StaticResource TouchButtonStyle}"
                            Background="#9C27B0"
                            Width="120" 
                            Height="50" 
                            Margin="5"
                            Click="SelectEventButton_Click"
                            ToolTip="Select Event">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="🎉" FontSize="18" Margin="0,0,6,0"/>
                            <TextBlock Text="Event" FontSize="16" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    
                    <!-- Print Settings Button -->
                    <Button Style="{StaticResource TouchButtonStyle}"
                            Background="#66BB6A"
                            Width="140" 
                            Height="50" 
                            Margin="5"
                            Click="PrintSettingsButton_Click"
                            ToolTip="Print Settings">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="⚙️🖨️" FontSize="18" Margin="0,0,6,0"/>
                            <TextBlock Text="Print Setup" FontSize="16" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource TouchButtonStyle}"
                            Background="#2196F3"
                            Width="140" 
                            Height="50" 
                            Margin="5"
                            Click="CameraSettingsButton_Click"
                            ToolTip="Camera Settings">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="📷" FontSize="18" Margin="0,0,6,0"/>
                            <TextBlock Text="Camera" FontSize="16" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource TouchButtonStyle}"
                            Background="#FF9800"
                            Width="120" 
                            Height="50" 
                            Margin="5"
                            Click="TimerSettingsButton_Click"
                            ToolTip="Timer Settings">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="⏲️" FontSize="18" Margin="0,0,6,0"/>
                            <TextBlock Text="Timer" FontSize="16" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource TouchButtonStyle}"
                            Background="#9C27B0"
                            Width="140" 
                            Height="50" 
                            Margin="5"
                            Click="SettingsButton_Click"
                            ToolTip="General Settings">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="⚙️" FontSize="18" Margin="0,0,6,0"/>
                            <TextBlock Text="Settings" FontSize="16" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    
                    <!-- Template Designer Button -->
                    <Button Style="{StaticResource TouchButtonStyle}"
                            Background="#FF5722"
                            Width="160" 
                            Height="50" 
                            Margin="5"
                            Click="TemplateDesignerButton_Click"
                            ToolTip="Open Template Designer">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="🎨" FontSize="18" Margin="0,0,6,0"/>
                            <TextBlock Text="Templates" FontSize="16" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <!-- Virtual Backgrounds Button -->
                    <Button Style="{StaticResource TouchButtonStyle}"
                            Background="#4CAF50"
                            Width="180"
                            Height="50"
                            Margin="5"
                            Click="VirtualBackgroundsButton_Click"
                            ToolTip="Manage Virtual Backgrounds">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="🌄" FontSize="18" Margin="0,0,6,0"/>
                            <TextBlock Text="Backgrounds" FontSize="16" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <!-- Sharing Status Button -->
                    <Button Style="{StaticResource TouchButtonStyle}"
                            Background="#607D8B"
                            Width="160"
                            Height="50"
                            Margin="5"
                            Click="SharingStatusButton_Click"
                            ToolTip="View Upload &amp; Sharing Queue">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="📤" FontSize="18" Margin="0,0,6,0"/>
                            <TextBlock Text="Queue Status" FontSize="16" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    
                    <!-- Touch Template Designer Button -->
                    <Button Style="{StaticResource TouchButtonStyle}"
                            Background="#9C27B0"
                            Width="160" 
                            Height="50" 
                            Margin="5"
                            Click="TouchTemplateDesignerButton_Click"
                            ToolTip="Open Touch Template Designer">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="✋" FontSize="18" Margin="0,0,6,0"/>
                            <TextBlock Text="Touch Designer" FontSize="16" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    
                    <!-- Fullscreen Toggle Button -->
                    <Button x:Name="FullscreenButton"
                            Style="{StaticResource TouchButtonStyle}"
                            Background="#37474F"
                            Width="140" 
                            Height="50" 
                            Margin="5"
                            Click="FullscreenButton_Click"
                            ToolTip="Toggle Fullscreen">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock x:Name="FullscreenIcon" Text="⛶" FontSize="18" Margin="0,0,6,0"/>
                            <TextBlock x:Name="FullscreenText" Text="Fullscreen" FontSize="16" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Bottom Bar Toggle Button (Chevron) - Auto-hide, corner position -->
        <Border x:Name="bottomBarToggle"
                Grid.Row="2"
                VerticalAlignment="Bottom" 
                HorizontalAlignment="Right" 
                Background="#FF2196F3" 
                CornerRadius="15,0,0,0"
                Padding="10,5"
                Cursor="Hand"
                MouseLeftButtonDown="ToggleBottomBar_Click"
                TouchDown="ToggleBottomBar_Click"
                MouseEnter="BottomBarToggle_MouseEnter"
                MouseLeave="BottomBarToggle_MouseLeave"
                TouchEnter="BottomBarToggle_TouchEnter"
                TouchLeave="BottomBarToggle_TouchLeave"
                Panel.ZIndex="499"
                Opacity="0.3"
                Margin="0,0,20,0">
            <Border.Effect>
                <DropShadowEffect Color="Black" BlurRadius="10" ShadowDepth="3" Opacity="0.5"/>
            </Border.Effect>
            <Border.RenderTransform>
                <TransformGroup>
                    <ScaleTransform x:Name="toggleScale" ScaleX="0.8" ScaleY="0.8"/>
                    <TranslateTransform/>
                </TransformGroup>
            </Border.RenderTransform>
            <Border.Triggers>
                <EventTrigger RoutedEvent="MouseEnter">
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                             To="1.0" Duration="0:0:0.2"/>
                            <DoubleAnimation Storyboard.TargetName="toggleScale"
                                             Storyboard.TargetProperty="ScaleX"
                                             To="1.0" Duration="0:0:0.2"/>
                            <DoubleAnimation Storyboard.TargetName="toggleScale"
                                             Storyboard.TargetProperty="ScaleY"
                                             To="1.0" Duration="0:0:0.2"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
                <EventTrigger RoutedEvent="MouseLeave">
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                             To="0.3" Duration="0:0:0.3"/>
                            <DoubleAnimation Storyboard.TargetName="toggleScale"
                                             Storyboard.TargetProperty="ScaleX"
                                             To="0.8" Duration="0:0:0.3"/>
                            <DoubleAnimation Storyboard.TargetName="toggleScale"
                                             Storyboard.TargetProperty="ScaleY"
                                             To="0.8" Duration="0:0:0.3"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
            </Border.Triggers>
            <StackPanel Orientation="Horizontal">
                <TextBlock x:Name="bottomBarToggleChevron" 
                           Text="⚙" 
                           FontSize="20" 
                           Foreground="White" 
                           FontWeight="Bold"/>
            </StackPanel>
        </Border>
        
        <!-- Old Event Selection Overlay - Replaced by EventSelectionOverlayControl -->
        <!-- Commented out to avoid conflicts with new EventSelectionOverlay control
        <Grid x:Name="eventSelectionOverlay" 
              Grid.Row="0" Grid.RowSpan="3" 
              Background="#CC000000" 
              Visibility="Collapsed">
        </Grid>
        -->
        
        <!-- Template Selection Overlay -->
        <Grid x:Name="templateSelectionOverlay" 
              Grid.Row="0" Grid.RowSpan="3" 
              Background="#CC000000" 
              Visibility="Collapsed">
            
            <Border Background="#2D2D30" 
                    CornerRadius="20" 
                    MaxWidth="1000" 
                    MaxHeight="700" 
                    HorizontalAlignment="Center" 
                    VerticalAlignment="Center"
                    Padding="40">
                <Border.Effect>
                    <DropShadowEffect Color="Black" BlurRadius="25" ShadowDepth="10" Opacity="0.7"/>
                </Border.Effect>
                
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Header -->
                    <StackPanel Grid.Row="0" Orientation="Vertical" Margin="0,0,0,30">
                        <TextBlock x:Name="templateSelectionEventName"
                                   Text="Select Template" 
                                   FontSize="32" 
                                   FontWeight="Bold" 
                                   Foreground="White" 
                                   HorizontalAlignment="Center"/>
                        <TextBlock x:Name="templateSelectionEventDescription"
                                   Text="" 
                                   FontSize="18" 
                                   Foreground="#CCCCCC" 
                                   HorizontalAlignment="Center"
                                   Margin="0,10,0,0"/>
                    </StackPanel>
                    
                    <!-- Template List -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <ItemsControl x:Name="templatesList" Margin="0,0,0,20">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal" HorizontalAlignment="Center"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="#404040" 
                                            CornerRadius="10" 
                                            Margin="10" 
                                            Width="200"
                                            Height="280"
                                            Cursor="Hand"
                                            MouseLeftButtonDown="TemplateItem_Click">
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Setter Property="Background" Value="#404040"/>
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#4CAF50"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        
                                        <StackPanel Margin="15">
                                            <!-- Template Preview -->
                                            <Border Background="#333" 
                                                    Height="150" 
                                                    CornerRadius="5" 
                                                    Margin="0,0,0,10">
                                                <TextBlock Text="📷" 
                                                           FontSize="48" 
                                                           HorizontalAlignment="Center" 
                                                           VerticalAlignment="Center" 
                                                           Foreground="#666"/>
                                            </Border>
                                            
                                            <!-- Template Info -->
                                            <TextBlock Text="{Binding Name}" 
                                                       FontSize="18" 
                                                       FontWeight="Bold" 
                                                       Foreground="White"
                                                       TextAlignment="Center"
                                                       TextWrapping="Wrap"/>
                                            <TextBlock Text="{Binding Description}" 
                                                       FontSize="14" 
                                                       Foreground="#CCCCCC" 
                                                       Margin="0,5,0,0" 
                                                       TextAlignment="Center"
                                                       TextWrapping="Wrap"/>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                    
                    <!-- Back Button -->
                    <Button Grid.Row="2" 
                            Content="← Back to Events" 
                            Style="{StaticResource TouchButtonStyle}" 
                            Background="#666666"
                            Width="250" 
                            Height="60" 
                            FontSize="18" 
                            HorizontalAlignment="Center" 
                            Click="BackToEventSelection_Click"/>
                </Grid>
            </Border>
        </Grid>
        
        <!-- Event Gallery Overlay -->
        <controls:GalleryOverlayControl x:Name="galleryOverlay"
                                        Grid.RowSpan="3"
                                        Visibility="Collapsed"/>
        
        <!-- Template Selection Overlay -->
        <Grid x:Name="templateSelectionOverlayNew"
              Grid.RowSpan="3"
              Background="#E0000000"
              Visibility="Collapsed">
            <Border Background="#FF2E2E2E"
                    CornerRadius="20"
                    Margin="50"
                    Padding="30">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Header -->
                    <Grid Grid.Row="0">
                        <TextBlock x:Name="templateSelectionTitle"
                                   Text="Select Template"
                                   FontSize="32"
                                   FontWeight="Bold"
                                   Foreground="White"
                                   HorizontalAlignment="Center"
                                   Margin="0,0,0,20"/>
                        
                        <!-- Close Button -->
                        <Button x:Name="closeTemplateSelection"
                                Content="✕"
                                Style="{StaticResource TouchButtonStyle}"
                                Background="#CC000000"
                                Width="50"
                                Height="50"
                                FontSize="24"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Top"
                                Margin="0,-10,-10,0"
                                Click="CloseTemplateSelection_Click"/>
                    </Grid>
                    
                    <!-- Subtitle -->
                    <TextBlock Grid.Row="1"
                               x:Name="templateSelectionSubtitle"
                               Text="Choose your photo layout"
                               FontSize="18"
                               Foreground="#CCCCCC"
                               HorizontalAlignment="Center"
                               Margin="0,0,0,30"/>
                    
                    <!-- Templates Grid -->
                    <ScrollViewer Grid.Row="2"
                                  VerticalScrollBarVisibility="Auto"
                                  HorizontalScrollBarVisibility="Disabled">
                        <ItemsControl x:Name="templatesGrid">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal"
                                               HorizontalAlignment="Center"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border x:Name="templateCard"
                                            Background="Transparent"
                                            CornerRadius="15"
                                            Width="320"
                                            Height="400"
                                            Margin="15"
                                            Cursor="Hand"
                                            MouseLeftButtonDown="TemplateCard_Click">
                                        <Border.Effect>
                                            <DropShadowEffect Color="Black"
                                                              BlurRadius="8"
                                                              ShadowDepth="3"
                                                              Opacity="0.2"/>
                                        </Border.Effect>
                                        
                                        <Grid>
                                            <!-- Template Preview Container - Full size -->
                                            <Grid>
                                                <!-- Actual Template Layout Preview -->
                                                <ContentPresenter x:Name="templatePreview"
                                                                  Content="{Binding Preview}"
                                                                  HorizontalAlignment="Center"
                                                                  VerticalAlignment="Center"
                                                                  Margin="10"/>
                                                
                                                <!-- Selection Overlay -->
                                                <Border x:Name="selectedOverlay"
                                                        Background="#4C4CAF50"
                                                        CornerRadius="10"
                                                        Visibility="{Binding IsSelected, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                    <TextBlock Text="✓ Selected"
                                                               FontSize="24"
                                                               FontWeight="Bold"
                                                               Foreground="White"
                                                               HorizontalAlignment="Center"
                                                               VerticalAlignment="Center"/>
                                                </Border>
                                            </Grid>
                                            
                                        </Grid>
                                        
                                        <!-- Hover Effect -->
                                        <Border.Triggers>
                                            <EventTrigger RoutedEvent="MouseEnter">
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.ScaleX"
                                                                         To="1.05"
                                                                         Duration="0:0:0.2"/>
                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.ScaleY"
                                                                         To="1.05"
                                                                         Duration="0:0:0.2"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </EventTrigger>
                                            <EventTrigger RoutedEvent="MouseLeave">
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.ScaleX"
                                                                         To="1.0"
                                                                         Duration="0:0:0.2"/>
                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.ScaleY"
                                                                         To="1.0"
                                                                         Duration="0:0:0.2"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </EventTrigger>
                                        </Border.Triggers>
                                        
                                        <Border.RenderTransform>
                                            <ScaleTransform ScaleX="1" ScaleY="1"
                                                            CenterX="160" CenterY="200"/>
                                        </Border.RenderTransform>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                    <!-- Footer Message -->
                    <TextBlock Grid.Row="3"
                               Text="Click on a template to start your session"
                               FontSize="14"
                               Foreground="#999999"
                               HorizontalAlignment="Center"
                               Margin="0,20,0,0"/>
                </Grid>
            </Border>
        </Grid>
        
        <!-- Print Copies Modal -->
        <controls:PrintCopiesModal x:Name="printCopiesModal" />
        
        <!-- Retake Selection Overlay -->
        <Grid x:Name="retakeSelectionOverlay"
              Background="#CC000000"
              Visibility="Collapsed"
              Grid.RowSpan="3">
            <Border Background="#1E1E1E"
                    CornerRadius="20"
                    MaxWidth="1400"
                    MaxHeight="900"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Margin="40">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Header -->
                    <Grid Grid.Row="0" Margin="30,20">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <StackPanel Grid.Column="0">
                            <TextBlock Text="Review Your Photos"
                                       FontSize="32"
                                       FontWeight="Light"
                                       Foreground="White"/>
                            <TextBlock x:Name="retakeInstructionText"
                                       Text="Click on any photo you want to retake"
                                       FontSize="16"
                                       Foreground="#AAAAAA"
                                       Margin="0,5,0,0"/>
                        </StackPanel>
                        
                        <!-- Timer Display -->
                        <StackPanel Grid.Column="1" 
                                    Orientation="Horizontal"
                                    VerticalAlignment="Center">
                            <TextBlock Text="Time remaining: "
                                       FontSize="16"
                                       Foreground="#AAAAAA"
                                       VerticalAlignment="Center"/>
                            <TextBlock x:Name="retakeTimerText"
                                       Text="15"
                                       FontSize="24"
                                       FontWeight="Bold"
                                       Foreground="White"
                                       VerticalAlignment="Center"/>
                            <TextBlock Text="s"
                                       FontSize="16"
                                       Foreground="#AAAAAA"
                                       VerticalAlignment="Center"
                                       Margin="2,0,0,0"/>
                        </StackPanel>
                    </Grid>
                    
                    <!-- Photo Grid -->
                    <ScrollViewer Grid.Row="1" 
                                  VerticalScrollBarVisibility="Auto"
                                  HorizontalScrollBarVisibility="Disabled"
                                  Margin="20,0">
                        <ItemsControl x:Name="retakePhotoGrid"
                                      HorizontalAlignment="Center">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal"
                                               HorizontalAlignment="Center"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Margin="15"
                                            Width="350"
                                            Height="280"
                                            CornerRadius="10"
                                            Background="#2A2A2A"
                                            BorderThickness="3"
                                            Cursor="Hand"
                                            MouseLeftButtonUp="RetakePhoto_Click"
                                            Tag="{Binding PhotoIndex}">
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Setter Property="BorderBrush" Value="Transparent"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding MarkedForRetake}" Value="True">
                                                        <Setter Property="BorderBrush" Value="#FF4444"/>
                                                    </DataTrigger>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Opacity" Value="0.8"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        
                                        <Grid>
                                            <!-- Photo -->
                                            <Image Source="{Binding Image}"
                                                   Stretch="UniformToFill"
                                                   RenderOptions.BitmapScalingMode="HighQuality"/>
                                            
                                            <!-- Label -->
                                            <TextBlock Text="{Binding Label}"
                                                       FontSize="14"
                                                       Foreground="White"
                                                       Background="#AA000000"
                                                       Padding="8,4"
                                                       HorizontalAlignment="Left"
                                                       VerticalAlignment="Top"
                                                       Margin="10"/>
                                            
                                            <!-- Retake Indicator -->
                                            <Grid Visibility="{Binding MarkedForRetake, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                <Rectangle Fill="#55FF0000"/>
                                                <TextBlock Text="RETAKE"
                                                           FontSize="28"
                                                           FontWeight="Bold"
                                                           Foreground="White"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center">
                                                    <TextBlock.Effect>
                                                        <DropShadowEffect Color="Black" 
                                                                          ShadowDepth="2" 
                                                                          BlurRadius="5"/>
                                                    </TextBlock.Effect>
                                                </TextBlock>
                                            </Grid>
                                            
                                            <!-- Hover Overlay -->
                                            <Border x:Name="hoverOverlay"
                                                    Background="#44FFFFFF"
                                                    Visibility="Collapsed">
                                                <TextBlock Text="&#xE74D;"
                                                           FontFamily="Segoe MDL2 Assets"
                                                           FontSize="48"
                                                           Foreground="White"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"/>
                                            </Border>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                    
                    <!-- Action Buttons -->
                    <StackPanel Grid.Row="2" 
                                Orientation="Horizontal" 
                                HorizontalAlignment="Center"
                                Margin="20">
                        <Button x:Name="retakeSelectedButton"
                                Content="Retake Selected"
                                Width="180"
                                Height="50"
                                Margin="10"
                                FontSize="16"
                                Background="#FF4444"
                                Foreground="White"
                                BorderThickness="0"
                                Click="RetakeSelected_Click">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#FF6666"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        
                        <Button x:Name="skipRetakeButton"
                                Content="Skip Retake"
                                Width="180"
                                Height="50"
                                Margin="10"
                                FontSize="16"
                                Background="#404040"
                                Foreground="White"
                                BorderThickness="0"
                                Click="SkipRetake_Click"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
        
        <!-- Filter Selection Overlay -->
        <Grid x:Name="filterSelectionOverlay" 
              Grid.RowSpan="3"
              Grid.ColumnSpan="3"
              Background="#E6000000"
              Visibility="Collapsed">
            
            <Border MaxWidth="1600" MaxHeight="900" Margin="40"
                    Background="#1E1E1E"
                    CornerRadius="15">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Header -->
                    <Border Grid.Row="0" Background="#2D2D30" CornerRadius="15,15,0,0" Padding="20">
                        <Grid>
                            <TextBlock Text="Select Photo Filter" 
                                       FontSize="28" 
                                       FontWeight="Bold" 
                                       Foreground="White"
                                       HorizontalAlignment="Center"/>
                            <Button x:Name="closeFilterSelection" 
                                    Content="✕" 
                                    FontSize="24"
                                    Width="40" 
                                    Height="40"
                                    HorizontalAlignment="Right"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    Foreground="White"
                                    Click="CloseFilterSelection_Click"/>
                        </Grid>
                    </Border>
                    
                    <!-- Filter Options Grid -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Margin="20">
                        <ItemsControl x:Name="filterItemsControl">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal" HorizontalAlignment="Center"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Button Width="320" 
                                            Height="400" 
                                            Margin="15"
                                            Background="#2D2D30"
                                            BorderBrush="#007ACC"
                                            BorderThickness="2"
                                            Click="FilterButton_Click"
                                            Tag="{Binding FilterType}"
                                            Cursor="Hand">
                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Setter Property="Template">
                                                    <Setter.Value>
                                                        <ControlTemplate TargetType="Button">
                                                            <Border Background="{TemplateBinding Background}"
                                                                    BorderBrush="{TemplateBinding BorderBrush}"
                                                                    BorderThickness="{TemplateBinding BorderThickness}"
                                                                    CornerRadius="12">
                                                                <Border.Effect>
                                                                    <DropShadowEffect Color="Black" BlurRadius="8" ShadowDepth="4" Opacity="0.3"/>
                                                                </Border.Effect>
                                                                <Grid>
                                                                    <Grid.RowDefinitions>
                                                                        <RowDefinition Height="*"/>
                                                                        <RowDefinition Height="50"/>
                                                                    </Grid.RowDefinitions>
                                                                    
                                                                    <!-- Filter Preview Image -->
                                                                    <Border Grid.Row="0" 
                                                                            Margin="8"
                                                                            CornerRadius="8"
                                                                            ClipToBounds="True">
                                                                        <Image Source="{Binding PreviewImage}" 
                                                                               Stretch="UniformToFill"
                                                                               RenderOptions.BitmapScalingMode="HighQuality">
                                                                            <Image.Style>
                                                                                <Style TargetType="Image">
                                                                                    <Style.Triggers>
                                                                                        <DataTrigger Binding="{Binding PreviewImage}" Value="{x:Null}">
                                                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                                                        </DataTrigger>
                                                                                    </Style.Triggers>
                                                                                </Style>
                                                                            </Image.Style>
                                                                        </Image>
                                                                    </Border>
                                                                    
                                                                    <!-- Loading indicator when no preview -->
                                                                    <TextBlock Grid.Row="0"
                                                                               Text="Loading..."
                                                                               FontSize="14"
                                                                               Foreground="#808080"
                                                                               HorizontalAlignment="Center"
                                                                               VerticalAlignment="Center">
                                                                        <TextBlock.Style>
                                                                            <Style TargetType="TextBlock">
                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                                <Style.Triggers>
                                                                                    <DataTrigger Binding="{Binding PreviewImage}" Value="{x:Null}">
                                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                                    </DataTrigger>
                                                                                </Style.Triggers>
                                                                            </Style>
                                                                        </TextBlock.Style>
                                                                    </TextBlock>
                                                                    
                                                                    <!-- Filter Name -->
                                                                    <Border Grid.Row="1" 
                                                                            Background="#1A1A1A" 
                                                                            CornerRadius="0,0,12,12">
                                                                        <TextBlock Text="{Binding Name}"
                                                                                   HorizontalAlignment="Center"
                                                                                   VerticalAlignment="Center"
                                                                                   Foreground="White"
                                                                                   FontSize="16"
                                                                                   FontWeight="SemiBold"/>
                                                                    </Border>
                                                                </Grid>
                                                            </Border>
                                                        </ControlTemplate>
                                                    </Setter.Value>
                                                </Setter>
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#3D3D40"/>
                                                        <Setter Property="BorderBrush" Value="#00A0E4"/>
                                                        <Setter Property="BorderThickness" Value="3"/>
                                                    </Trigger>
                                                    <Trigger Property="IsPressed" Value="True">
                                                        <Setter Property="Background" Value="#4D4D50"/>
                                                        <Setter Property="BorderBrush" Value="#00C0FF"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                    
                    <!-- Action Buttons -->
                    <StackPanel Grid.Row="2" 
                                Orientation="Horizontal" 
                                HorizontalAlignment="Center"
                                Margin="20">
                        <Button x:Name="applyNoFilterButton"
                                Content="Continue Without Filter"
                                Width="200"
                                Height="50"
                                Margin="10"
                                FontSize="16"
                                Background="#404040"
                                Foreground="White"
                                BorderThickness="0"
                                Click="ApplyNoFilter_Click"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
        
        <!-- Camera Settings Overlay -->
        <controls:CameraSettingsOverlay x:Name="CameraSettingsOverlayControl" 
                                         Visibility="Collapsed"
                                         Grid.RowSpan="10"
                                         Panel.ZIndex="1000"/>
        
        <!-- Timer Settings Overlay -->
        <controls:TimerSettingsOverlay x:Name="TimerSettingsOverlayControl" 
                                        Visibility="Collapsed"
                                        Grid.RowSpan="10"
                                        Panel.ZIndex="1000"/>
        
        <!-- Print Settings Overlay -->
        <controls:PrintSettingsOverlay x:Name="PrintSettingsOverlayControl" 
                                        Visibility="Collapsed"
                                        Grid.RowSpan="10"
                                        Panel.ZIndex="1000"/>
        
        <!-- Event Selection Overlay -->
        <controls:EventSelectionOverlay x:Name="EventSelectionOverlayControl"
                                         Visibility="Collapsed"
                                         Grid.RowSpan="10"
                                         Panel.ZIndex="1000"/>
        
        <!-- Settings Overlay -->
        <controls:SettingsOverlay x:Name="SettingsOverlayControl"
                                   Visibility="Collapsed"
                                   Grid.RowSpan="10"
                                   Panel.ZIndex="1000"/>
        
        <!-- Sharing Status Overlay -->
        <controls:SharingStatusOverlay x:Name="SharingStatusOverlayControl"
                                       Visibility="Collapsed"
                                       Grid.RowSpan="10"
                                       Panel.ZIndex="1001"/>
        
        <!-- Template Designer Overlay - Full Screen -->
        <controls:TemplateDesignerOverlay x:Name="TemplateDesignerOverlayControl"
                                           Visibility="Collapsed"
                                           Grid.Row="0"
                                           Grid.Column="0"
                                           Grid.RowSpan="10"
                                           Grid.ColumnSpan="10"
                                           Panel.ZIndex="2000"/>

        <!-- AI Transformation Overlay -->
        <controls:AITransformationOverlay x:Name="AITransformationOverlayControl"
                                           Visibility="Collapsed"
                                           Grid.Row="0"
                                           Grid.Column="0"
                                           Grid.RowSpan="10"
                                           Grid.ColumnSpan="10"
                                           Panel.ZIndex="1500"/>
        
        <!-- PIN Entry Overlay (highest z-index for security) -->
        <controls:PinEntryOverlay x:Name="PinEntryOverlayControl"
                                   Visibility="Collapsed"
                                   Grid.RowSpan="10"
                                   Panel.ZIndex="9999"/>
    </Grid>
</Page>